<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evan's Dashboard ‚ú®</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 2rem;
        }
        .container { max-width: 900px; margin: 0 auto; }
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        header h1 { font-size: 2rem; font-weight: 300; }
        header .emoji { font-size: 2.5rem; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .price-row:last-child { border-bottom: none; }
        .coin-name { font-weight: 500; }
        .coin-price { font-size: 1.1rem; }
        .change { font-size: 0.85rem; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .change.up { background: rgba(0,200,100,0.2); color: #00c864; }
        .change.down { background: rgba(255,80,80,0.2); color: #ff5050; }
        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
        }
        .balance-value { font-size: 1.5rem; font-weight: 600; color: #ffd700; }
        .balance-usd { color: #888; font-size: 0.9rem; }
        .wallet-addr {
            font-size: 0.7rem;
            color: #555;
            word-break: break-all;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .status-dot {
            width: 8px; height: 8px;
            background: #00c864;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .update-time { color: #555; font-size: 0.8rem; text-align: center; margin-top: 2rem; }
        .home-link { text-align: center; margin-top: 1rem; }
        .home-link a { color: #ffd700; text-decoration: none; }
        .loading { color: #555; }
        .rules {
            font-size: 0.85rem;
            line-height: 1.8;
            color: #888;
        }
        .rules li { margin-bottom: 0.5rem; }
        .rule-warn { color: #ff5050; }
        .rule-safe { color: #00c864; }
        .chart-card { grid-column: 1 / -1; }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .chart-container { height: 350px; border-radius: 8px; overflow: hidden; }
        .period-btns { display: flex; gap: 0.5rem; }
        .period-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .period-btn.active { background: #ffd700; color: #000; }
        .indicators-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .indicator-item { text-align: center; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px; }
        .indicator-label { font-size: 0.75rem; color: #666; margin-bottom: 0.3rem; }
        .indicator-value { font-size: 1.1rem; font-weight: 600; }
        .indicator-signal { font-size: 0.7rem; margin-top: 0.2rem; }
        .bullish { color: #00c864; }
        .bearish { color: #ff5050; }
        .neutral { color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="emoji">‚ú®</div>
            <h1>Evan's Trading Dashboard</h1>
        </header>

        <div class="grid">
            <!-- Market Prices -->
            <div class="card">
                <h2>üìä Â∏ÇÂú∫Ë°åÊÉÖ</h2>
                <div id="market" class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>

            <!-- Wallet Balance -->
            <div class="card">
                <h2>üí∞ ÊàëÁöÑÈí±ÂåÖ</h2>
                <div class="status">
                    <div class="status-dot"></div>
                    <span style="color:#00c864; font-size:0.85rem;">Âú®Á∫ø</span>
                </div>
                <div id="wallet" class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>

            <!-- Trading Rules -->
            <div class="card">
                <h2>üìú ‰∫§ÊòìËßÑÂàô</h2>
                <ul class="rules">
                    <li class="rule-warn">üîí ‰øùÂ∫ïËµÑÈáë 100U Áªù‰∏çÂä®Áî®</li>
                    <li>üìä ÂçïÁ¨îÊúÄÂ§ß‰ªì‰Ωç: 20U (10%)</li>
                    <li>‚õî ÂçïÁ¨îÊ≠¢Êçü: -25%</li>
                    <li class="rule-safe">‚úÖ Âè™Áî®‰∏ªÊµÅ DEX</li>
                    <li class="rule-warn">‚ùå ‰∏çÁªôÈôåÁîüÂ∫îÁî®ÊéàÊùÉ</li>
                </ul>
            </div>

            <!-- K-Line Chart -->
            <div class="card chart-card">
                <div class="chart-header">
                    <h2>üìà SOL KÁ∫øÂõæ</h2>
                    <div class="period-btns">
                        <button class="period-btn" data-period="1d">1D</button>
                        <button class="period-btn active" data-period="7d">7D</button>
                        <button class="period-btn" data-period="30d">30D</button>
                    </div>
                </div>
                <div id="chartContainer" class="chart-container"></div>
                <div id="indicators" class="indicators-grid">
                    <div class="indicator-item">
                        <div class="indicator-label">MA(7)</div>
                        <div class="indicator-value" id="ma7">-</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">MA(20)</div>
                        <div class="indicator-value" id="ma20">-</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">MA(50)</div>
                        <div class="indicator-value" id="ma50">-</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">RSI(14)</div>
                        <div class="indicator-value" id="rsi14">-</div>
                        <div class="indicator-signal" id="rsiSignal">-</div>
                    </div>
                </div>
            </div>
        </div>

        <p class="update-time">‰∏äÊ¨°Êõ¥Êñ∞: <span id="updateTime">-</span></p>
        <p class="home-link"><a href="/">‚Üê ËøîÂõûÈ¶ñÈ°µ</a></p>
    </div>

    <script>
        async function fetchData() {
            try {
                // Fetch market data directly from Binance (client-side)
                let market = { success: true, data: { btc: {}, eth: {}, sol: {} } };
                try {
                    const [btcRes, ethRes, solRes] = await Promise.all([
                        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT'),
                        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=ETHUSDT'),
                        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=SOLUSDT')
                    ]);
                    const [btc, eth, sol] = await Promise.all([btcRes.json(), ethRes.json(), solRes.json()]);
                    market.data.btc = { price: parseFloat(btc.lastPrice), change: parseFloat(btc.priceChangePercent) };
                    market.data.eth = { price: parseFloat(eth.lastPrice), change: parseFloat(eth.priceChangePercent) };
                    market.data.sol = { price: parseFloat(sol.lastPrice), change: parseFloat(sol.priceChangePercent) };
                } catch (e) {
                    console.error('Binance API error:', e);
                }
                if (market.success) {
                    const m = market.data;
                    document.getElementById('market').innerHTML = `
                        <div class="price-row">
                            <span class="coin-name">BTC</span>
                            <span class="coin-price">$${m.btc.price?.toLocaleString() || '-'}</span>
                            <span class="change ${m.btc.change >= 0 ? 'up' : 'down'}">${m.btc.change >= 0 ? '+' : ''}${m.btc.change?.toFixed(2) || '-'}%</span>
                        </div>
                        <div class="price-row">
                            <span class="coin-name">ETH</span>
                            <span class="coin-price">$${m.eth.price?.toLocaleString() || '-'}</span>
                            <span class="change ${m.eth.change >= 0 ? 'up' : 'down'}">${m.eth.change >= 0 ? '+' : ''}${m.eth.change?.toFixed(2) || '-'}%</span>
                        </div>
                        <div class="price-row">
                            <span class="coin-name">SOL</span>
                            <span class="coin-price">$${m.sol.price?.toLocaleString() || '-'}</span>
                            <span class="change ${m.sol.change >= 0 ? 'up' : 'down'}">${m.sol.change >= 0 ? '+' : ''}${m.sol.change?.toFixed(2) || '-'}%</span>
                        </div>
                    `;
                }

                // Fetch wallet data
                const walletRes = await fetch('/api/wallet');
                const wallet = await walletRes.json();
                if (wallet.success) {
                    const w = wallet.data;
                    const solUsd = (w.sol * (market.data?.sol?.price || 100)).toFixed(2);
                    const totalUsd = (parseFloat(solUsd) + w.usdt).toFixed(2);
                    document.getElementById('wallet').innerHTML = `
                        <div class="balance-item">
                            <span>SOL</span>
                            <div>
                                <div class="balance-value">${w.sol?.toFixed(4) || '0'}</div>
                                <div class="balance-usd">‚âà $${solUsd}</div>
                            </div>
                        </div>
                        <div class="balance-item">
                            <span>USDT</span>
                            <div>
                                <div class="balance-value">${w.usdt?.toFixed(2) || '0'}</div>
                            </div>
                        </div>
                        <div class="balance-item" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem; padding-top: 1rem;">
                            <span>ÊÄªËÆ°</span>
                            <div class="balance-value">‚âà $${totalUsd}</div>
                        </div>
                        <div class="wallet-addr">üìç ${wallet.address}</div>
                    `;
                }

                document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');
            } catch (e) {
                console.error(e);
            }
        }

        fetchData();
        setInterval(fetchData, 30000); // Update every 30s

        // K-Line Chart
        let chart, candlestickSeries;
        let currentPeriod = '7d';

        function initChart() {
            const container = document.getElementById('chartContainer');
            chart = LightweightCharts.createChart(container, {
                layout: { background: { color: 'transparent' }, textColor: '#888' },
                grid: { vertLines: { color: 'rgba(255,255,255,0.05)' }, horzLines: { color: 'rgba(255,255,255,0.05)' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)' },
                timeScale: { borderColor: 'rgba(255,255,255,0.1)', timeVisible: true }
            });
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#00c864', downColor: '#ff5050',
                borderUpColor: '#00c864', borderDownColor: '#ff5050',
                wickUpColor: '#00c864', wickDownColor: '#ff5050'
            });
            chart.timeScale().fitContent();
        }

        async function loadChartData(period = '7d') {
            try {
                const res = await fetch(`/api/history/SOL?period=${period}`);
                const json = await res.json();
                if (json.data) {
                    const chartData = json.data.map(([time, open, high, low, close]) => ({
                        time: Math.floor(time / 1000),
                        open, high, low, close
                    }));
                    candlestickSeries.setData(chartData);
                    chart.timeScale().fitContent();
                }
            } catch (e) { console.error('Chart error:', e); }
        }

        async function loadIndicators() {
            try {
                const res = await fetch('/api/indicators/SOL');
                const json = await res.json();
                if (json.indicators) {
                    const { ma, rsi } = json.indicators;
                    document.getElementById('ma7').textContent = ma.ma7 ? `$${ma.ma7}` : '-';
                    document.getElementById('ma20').textContent = ma.ma20 ? `$${ma.ma20}` : '-';
                    document.getElementById('ma50').textContent = ma.ma50 ? `$${ma.ma50}` : '-';
                    const rsiVal = parseFloat(rsi.rsi14);
                    document.getElementById('rsi14').textContent = rsi.rsi14 || '-';
                    const rsiSignal = document.getElementById('rsiSignal');
                    if (rsiVal >= 70) { rsiSignal.textContent = 'Ë∂Ö‰π∞'; rsiSignal.className = 'indicator-signal bearish'; }
                    else if (rsiVal <= 30) { rsiSignal.textContent = 'Ë∂ÖÂçñ'; rsiSignal.className = 'indicator-signal bullish'; }
                    else { rsiSignal.textContent = '‰∏≠ÊÄß'; rsiSignal.className = 'indicator-signal neutral'; }
                }
            } catch (e) { console.error('Indicators error:', e); }
        }

        // Period button handlers
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriod = btn.dataset.period;
                loadChartData(currentPeriod);
            });
        });

        // Initialize chart
        initChart();
        loadChartData(currentPeriod);
        loadIndicators();
        setInterval(() => { loadChartData(currentPeriod); loadIndicators(); }, 60000);
    </script>
</body>
</html>
