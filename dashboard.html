<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { margin-bottom: 30px; font-size: 24px; }
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 24px;
    }
    .label { color: #8b949e; font-size: 14px; margin-bottom: 8px; }
    .wallet-address {
      font-family: monospace;
      font-size: 14px;
      word-break: break-all;
      color: #58a6ff;
      margin-bottom: 24px;
    }
    .balance {
      font-size: 36px;
      font-weight: 600;
    }
    .balance-label { color: #8b949e; font-size: 14px; }
    .usd-value {
      font-size: 20px;
      color: #7ee787;
      margin-top: 4px;
    }
    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #30363d;
    }
    .price {
      font-size: 24px;
      font-weight: 600;
    }
    .loading { color: #8b949e; }
    .error { color: #f85149; }
    .refresh-btn {
      margin-top: 20px;
      padding: 8px 16px;
      background: #238636;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .refresh-btn:hover { background: #2ea043; }

    /* History section */
    .history-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #30363d;
    }
    .period-selector {
      display: flex;
      gap: 8px;
      margin: 12px 0;
    }
    .period-btn {
      padding: 6px 12px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #8b949e;
      cursor: pointer;
      font-size: 13px;
    }
    .period-btn:hover { border-color: #58a6ff; }
    .period-btn.active {
      background: #388bfd26;
      border-color: #58a6ff;
      color: #58a6ff;
    }
    .ohlc-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    .ohlc-table th {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #30363d;
      color: #8b949e;
      font-weight: 500;
    }
    .ohlc-table td {
      padding: 8px;
      border-bottom: 1px solid #21262d;
    }
    .ohlc-table tr:hover { background: #21262d; }
    .positive { color: #7ee787; }
    .negative { color: #f85149; }
    .table-container {
      max-height: 300px;
      overflow-y: auto;
    }

    /* Technical Indicators */
    .indicators-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #30363d;
    }
    .indicators-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 12px;
    }
    .indicator-card {
      background: #21262d;
      border-radius: 6px;
      padding: 12px;
    }
    .indicator-title {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 8px;
    }
    .indicator-value {
      font-size: 18px;
      font-weight: 600;
    }
    .indicator-signal {
      font-size: 11px;
      margin-top: 4px;
    }
    .signal-bullish { color: #7ee787; }
    .signal-bearish { color: #f85149; }
    .signal-neutral { color: #8b949e; }
    .ma-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ma-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }
    .ma-label { color: #8b949e; }

    /* Symbol Selector */
    .symbol-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .symbol-btn {
      padding: 8px 16px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #8b949e;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .symbol-btn:hover { border-color: #58a6ff; }
    .symbol-btn.active {
      background: #388bfd26;
      border-color: #58a6ff;
      color: #58a6ff;
    }

    /* Chart Section */
    .chart-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #30363d;
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .chart-period-selector {
      display: flex;
      gap: 8px;
    }
    .chart-period-btn {
      padding: 6px 12px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #8b949e;
      cursor: pointer;
      font-size: 13px;
    }
    .chart-period-btn:hover { border-color: #58a6ff; }
    .chart-period-btn.active {
      background: #388bfd26;
      border-color: #58a6ff;
      color: #58a6ff;
    }
    #chart-container {
      width: 100%;
      height: 400px;
      border-radius: 6px;
      overflow: hidden;
      background: #161b22;
    }
  </style>
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <div class="container">
    <h1>Trading Dashboard</h1>
    
    <!-- Symbol Selector -->
    <div class="symbol-selector">
      <button class="symbol-btn active" data-symbol="SOL">SOL</button>
      <button class="symbol-btn" data-symbol="BTC">BTC</button>
      <button class="symbol-btn" data-symbol="ETH">ETH</button>
    </div>

    <div class="card">
      <div class="label">Wallet Address</div>
      <div class="wallet-address" id="address">3UcvGwXci9Xi73EBwaj6NmVvx8iHVqh5eomuTuLa6QTw</div>
      <div class="label">SOL Balance</div>
      <div class="balance" id="balance"><span class="loading">Loading...</span></div>
      <div class="usd-value" id="usd-value"></div>

      <div class="price-row">
        <div>
          <div class="label">SOL Price</div>
          <div class="price" id="sol-price"><span class="loading">Loading...</span></div>
        </div>
      </div>

      <button class="refresh-btn" onclick="refreshAll()">Refresh</button>

      <!-- K-Line Chart Section -->
      <div class="chart-section">
        <div class="chart-header">
          <div class="label">SOL K-Line Chart</div>
          <div class="chart-period-selector">
            <button class="chart-period-btn" data-chart-period="1d">1D</button>
            <button class="chart-period-btn active" data-chart-period="7d">7D</button>
            <button class="chart-period-btn" data-chart-period="30d">30D</button>
          </div>
        </div>
        <div id="chart-container"></div>
      </div>

      <!-- Technical Indicators Section -->
      <div class="indicators-section">
        <div class="label">Technical Indicators (SOL)</div>
        <div class="indicators-grid">
          <div class="indicator-card">
            <div class="indicator-title">Moving Averages</div>
            <div class="ma-list" id="ma-values">
              <span class="loading">Loading...</span>
            </div>
          </div>
          <div class="indicator-card">
            <div class="indicator-title">RSI (14)</div>
            <div class="indicator-value" id="rsi-value">
              <span class="loading">Loading...</span>
            </div>
            <div class="indicator-signal" id="rsi-signal"></div>
          </div>
        </div>
      </div>

      <!-- History Section -->
      <div class="history-section">
        <div class="label">SOL Price History (OHLC)</div>
        <div class="period-selector">
          <button class="period-btn" data-period="1d">1D</button>
          <button class="period-btn active" data-period="7d">7D</button>
          <button class="period-btn" data-period="30d">30D</button>
          <button class="period-btn" data-period="90d">90D</button>
        </div>
        <div class="table-container">
          <table class="ohlc-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Open</th>
                <th>High</th>
                <th>Low</th>
                <th>Close</th>
                <th>Change</th>
              </tr>
            </thead>
            <tbody id="ohlc-body">
              <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WALLET_ADDRESS = '3UcvGwXci9Xi73EBwaj6NmVvx8iHVqh5eomuTuLa6QTw';
    const LAMPORTS_PER_SOL = 1_000_000_000;
    const SOL_MINT = 'So11111111111111111111111111111111111111112';

    // Supported symbols
    const SYMBOLS = {
      SOL: { name: 'Solana', mint: 'So11111111111111111111111111111111111111112' },
      BTC: { name: 'Bitcoin', mint: null },
      ETH: { name: 'Ethereum', mint: null }
    };

    let currentSymbol = 'SOL';
    let currentSolPrice = null;
    let currentSolBalance = null;

    function updateUsdValue() {
      const usdValueEl = document.getElementById('usd-value');
      if (currentSolPrice && currentSolBalance) {
        const usdValue = (currentSolBalance * currentSolPrice).toFixed(2);
        usdValueEl.textContent = `â‰ˆ $${usdValue} USD`;
      } else {
        usdValueEl.textContent = '';
      }
    }

    async function fetchPrice() {
      const priceEl = document.getElementById('sol-price');
      priceEl.innerHTML = '<span class="loading">Loading...</span>';

      try {
        const response = await fetch('/api/price');
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        const priceData = data.data[SOL_MINT];
        if (priceData && priceData.price) {
          currentSolPrice = parseFloat(priceData.price);
          priceEl.innerHTML = `$${currentSolPrice.toFixed(2)} <span class="balance-label">USD</span>`;
          updateUsdValue();
        } else {
          throw new Error('Price data not available');
        }
      } catch (error) {
        priceEl.innerHTML = `<span class="error">Error: ${error.message}</span>`;
        currentSolPrice = null;
      }
    }

    async function fetchBalance() {
      const balanceEl = document.getElementById('balance');
      balanceEl.innerHTML = '<span class="loading">Loading...</span>';

      try {
        const response = await fetch('/api/balance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ walletAddress: WALLET_ADDRESS })
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error.message || data.error);
        }

        currentSolBalance = data.result.value / LAMPORTS_PER_SOL;
        balanceEl.innerHTML = `${currentSolBalance.toFixed(4)} <span class="balance-label">SOL</span>`;
        updateUsdValue();
      } catch (error) {
        balanceEl.innerHTML = `<span class="error">Error: ${error.message}</span>`;
        currentSolBalance = null;
      }
    }

    let currentPeriod = '7d';

    async function fetchHistory(period = currentPeriod) {
      const tbody = document.getElementById('ohlc-body');
      tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`/api/history/${currentSymbol}?period=${period}`);
        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        if (!result.data || result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6">No data available</td></tr>';
          return;
        }

        // Reverse to show most recent first
        const rows = result.data.slice().reverse().map(([timestamp, open, high, low, close]) => {
          const date = new Date(timestamp);
          const timeStr = date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          const change = ((close - open) / open * 100).toFixed(2);
          const changeClass = change >= 0 ? 'positive' : 'negative';
          const changePrefix = change >= 0 ? '+' : '';

          return `<tr>
            <td>${timeStr}</td>
            <td>$${open.toFixed(2)}</td>
            <td>$${high.toFixed(2)}</td>
            <td>$${low.toFixed(2)}</td>
            <td>$${close.toFixed(2)}</td>
            <td class="${changeClass}">${changePrefix}${change}%</td>
          </tr>`;
        }).join('');

        tbody.innerHTML = rows;
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="6" class="error">Error: ${error.message}</td></tr>`;
      }
    }

    // Period button handlers
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPeriod = btn.dataset.period;
        fetchHistory(currentPeriod);
      });
    });

    async function fetchIndicators() {
      const maValues = document.getElementById('ma-values');
      const rsiValue = document.getElementById('rsi-value');
      const rsiSignal = document.getElementById('rsi-signal');

      maValues.innerHTML = '<span class="loading">Loading...</span>';
      rsiValue.innerHTML = '<span class="loading">Loading...</span>';
      rsiSignal.textContent = '';

      try {
        const response = await fetch(`/api/indicators/${currentSymbol}`);
        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        const { ma, rsi } = result.indicators;
        const price = result.price;

        // Display MAs with trend signals
        const maHtml = [
          { label: 'MA(7)', value: ma.ma7 },
          { label: 'MA(20)', value: ma.ma20 },
          { label: 'MA(50)', value: ma.ma50 }
        ].map(({ label, value }) => {
          if (value === null) return `<div class="ma-item"><span class="ma-label">${label}</span><span>N/A</span></div>`;
          const signalClass = price > value ? 'positive' : 'negative';
          return `<div class="ma-item">
            <span class="ma-label">${label}</span>
            <span class="${signalClass}">$${value.toFixed(2)}</span>
          </div>`;
        }).join('');

        maValues.innerHTML = maHtml;

        // Display RSI with interpretation
        if (rsi.rsi14 !== null) {
          const rsiVal = rsi.rsi14;
          rsiValue.textContent = rsiVal.toFixed(2);

          let signal, signalClass;
          if (rsiVal >= 70) {
            signal = 'Overbought';
            signalClass = 'signal-bearish';
          } else if (rsiVal <= 30) {
            signal = 'Oversold';
            signalClass = 'signal-bullish';
          } else {
            signal = 'Neutral';
            signalClass = 'signal-neutral';
          }

          rsiSignal.textContent = signal;
          rsiSignal.className = `indicator-signal ${signalClass}`;
        } else {
          rsiValue.textContent = 'N/A';
        }
      } catch (error) {
        maValues.innerHTML = `<span class="error">Error: ${error.message}</span>`;
        rsiValue.innerHTML = `<span class="error">Error</span>`;
      }
    }

    // K-Line Chart
    let chart = null;
    let candlestickSeries = null;
    let chartPeriod = '7d';

    function initChart() {
      const container = document.getElementById('chart-container');

      // Ensure container has dimensions
      const width = container.clientWidth || 560;
      const height = container.clientHeight || 400;

      chart = LightweightCharts.createChart(container, {
        width: width,
        height: height,
        layout: {
          background: { type: 'solid', color: '#161b22' },
          textColor: '#8b949e',
        },
        grid: {
          vertLines: { color: '#21262d' },
          horzLines: { color: '#21262d' },
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
          borderColor: '#30363d',
        },
        timeScale: {
          borderColor: '#30363d',
          timeVisible: true,
          secondsVisible: false,
        },
      });

      candlestickSeries = chart.addCandlestickSeries({
        upColor: '#7ee787',
        downColor: '#f85149',
        borderUpColor: '#7ee787',
        borderDownColor: '#f85149',
        wickUpColor: '#7ee787',
        wickDownColor: '#f85149',
      });

      // Responsive resize
      window.addEventListener('resize', () => {
        chart.applyOptions({
          width: container.clientWidth,
          height: container.clientHeight
        });
      });
    }

    async function fetchChartData(period = chartPeriod) {
      try {
        const response = await fetch(`/api/history/${currentSymbol}?period=${period}`);
        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        if (!result.data || result.data.length === 0) {
          console.warn('No chart data available');
          return;
        }

        // Convert data to candlestick format and sort by time
        const candleData = result.data
          .map(([timestamp, open, high, low, close]) => ({
            time: Math.floor(timestamp / 1000), // Convert to seconds
            open: parseFloat(open),
            high: parseFloat(high),
            low: parseFloat(low),
            close: parseFloat(close),
          }))
          .sort((a, b) => a.time - b.time); // Ensure sorted by time ascending

        // Remove duplicates (same timestamp)
        const uniqueData = candleData.filter((item, index, arr) =>
          index === 0 || item.time !== arr[index - 1].time
        );

        candlestickSeries.setData(uniqueData);
        chart.timeScale().fitContent();
      } catch (error) {
        console.error('Failed to fetch chart data:', error);
      }
    }

    // Chart period button handlers
    document.querySelectorAll('.chart-period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chart-period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        chartPeriod = btn.dataset.chartPeriod;
        fetchChartData(chartPeriod);
      });
    });

    function refreshAll() {
      fetchBalance();
      fetchPrice();
      fetchHistory();
      fetchIndicators();
      fetchChartData();
    }

    // Symbol selector handlers
    document.querySelectorAll('.symbol-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.symbol-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSymbol = btn.dataset.symbol;
        // Update labels
        document.querySelector('.chart-header .label').textContent = `${currentSymbol} K-Line Chart`;
        document.querySelector('.indicators-section .label').textContent = `Technical Indicators (${currentSymbol})`;
        document.querySelector('.history-section .label').textContent = `${currentSymbol} Price History (OHLC)`;
        // Refresh data for new symbol
        fetchHistory();
        fetchIndicators();
        fetchChartData();
      });
    });

    // Initialize chart on load
    initChart();
    refreshAll();
  </script>
</body>
</html>
